<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>OCTA X</title>

  <link rel="stylesheet" href="/css/stylesheet.css">
  <link rel="stylesheet" href="/css/responsivestyle.css">
  <link rel="stylesheet" href="/font-awesome/css/font-awesome.min.css">
  <link rel="icon" type="image/x-icon" href="./images/favicon.png">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/js/bootstrap.bundle.min.js"></script>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-firestore.js"></script>

  <script src="https://kit.fontawesome.com/3defd9afa9.js" crossorigin="anonymous"></script>
  <script src="https://kit.fontawesome.com/a8f8257674.js" crossorigin="anonymous"></script>
</head>
<body>

<div class="mainbody">
  <div class="innerBody mainSellBody">
    <div class="otherhead otherheadSection">
      <a href="/sell-usdt.html">
        <img src="/images/back.png" class="backimg">
      </a>
      <h4>Add Bank Account Details</h4>
    </div>

    <div class="account_addsection">
      <div>
        <label>Account No.</label>
        <input type="text" id="account" placeholder="Please enter Bank Account Number">
      </div>
      <div>
        <label>IFSC Code</label>
        <input type="text" id="ifsc" placeholder="Please enter IFSC code">
      </div>
      <div>
        <label>Payee Name</label>
        <input type="text" id="name" placeholder="Please enter a/c holder name">
      </div>
    </div>

    <div class="butonscomit">
      <button class="comitbutton" id="commit">Submit</button>
    </div>
    <p class="comitp">Please verify your account details carefully to avoid any losses.</p>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-app.js";
  import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-firestore.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-auth.js"; // NEW IMPORT

  const firebaseConfig = {
    apiKey: "AIzaSyBplXdPF8ogTbsFOiNDPhBZIAUMPVJqDjc",
    authDomain: "first-47e77.firebaseapp.com",
    projectId: "first-47e77",
    storageBucket: "first-47e77.appspot.com",
    messagingSenderId: "326623691876",
    appId: "1:326623691876:web:ded81074a6f236ac3f0b71"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app); // NEW: Initialize auth

  // Wait for the user to be authenticated before running the code
  onAuthStateChanged(auth, async (user) => {
    if (user) {
      document.getElementById('commit').addEventListener('click', async () => {
        const account = document.getElementById('account').value.trim();
        const ifsc = document.getElementById('ifsc').value.trim();
        const name = document.getElementById('name').value.trim();

        if (!account || !ifsc || !name) {
          alert("Please fill all fields");
          return;
        }

        try {
          // NEW: Save the data to the user-specific subcollection
          const userBankAccountsRef = collection(db, "users", user.uid, "bankAccounts");
          await addDoc(userBankAccountsRef, {
            account: account,
            ifsc: ifsc,
            name: name,
            timestamp: new Date()
          });
          window.location.href = "/bank.html";
        } catch (e) {
          console.error("Error adding document: ", e);
          alert("Failed to save data.");
        }
      });
    } else {
      // User is signed out, handle this state
      alert("You must be logged in to add a bank account.");
      window.location.href = "/login.html"; // Redirect to your login page
    }
  });
</script>

</body>
</html>