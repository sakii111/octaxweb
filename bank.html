<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>OCTA X</title>

  <link rel="stylesheet" href="/css/stylesheet.css">
  <link rel="stylesheet" href="/css/responsivestyle.css">
  <link rel="stylesheet" href="/font-awesome/css/font-awesome.min.css">
  <link rel="icon" type="image/x-icon" href="./images/favicon.png">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/js/bootstrap.bundle.min.js"></script>

  <style>
    .delete-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      cursor: pointer;
      color: red;
      font-size: 18px;
      z-index: 10;
    }
    .card {
      position: relative;
      border-radius: 10px;
    }
    .add-btn {
      position: fixed;
      bottom: 15px;
      left: 50%;
      transform: translateX(-50%);
      width: 95%;
      max-width: 500px;
      background-color: #12BF54;
      color: white;
      font-size: 18px;
      padding: 14px 0;
      border: none;
      border-radius: 10px;
      text-align: center;
      box-shadow: 0px 4px 8px rgba(0,0,0,0.2);
      cursor: pointer;
    }
    .add-btn:active {
      opacity: 0.9;
    }
    /* Skeleton Loader */
    .skeleton {
      background: linear-gradient(90deg, #e0e0e0 25%, #f4f4f4 50%, #e0e0e0 75%);
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
      border-radius: 8px;
    }
    @keyframes shimmer {
      0% { background-position: -200% 0; }
      100% { background-position: 200% 0; }
    }
    .skeleton-line {
      height: 14px;
      margin-bottom: 8px;
    }
    .skeleton-card {
      padding: 15px;
      margin-bottom: 10px;
    }
  </style>
</head>
<body>

<div class="mainbody">
  <div class="innerBody" style="background: #fafafa;">
    <div class="otherhead otherheadSection">
      <a href="/mine.html">
        <img src="/images/back.png" class="backimg">
      </a>
      <h4>Bank Account</h4>
    </div>

    <div id="accountList" class="p-3">
      <div class="skeleton skeleton-card">
        <div class="skeleton-line" style="width: 60%;"></div>
        <div class="skeleton-line" style="width: 40%;"></div>
        <div class="skeleton-line" style="width: 80%;"></div>
      </div>
      <div class="skeleton skeleton-card">
        <div class="skeleton-line" style="width: 70%;"></div>
        <div class="skeleton-line" style="width: 50%;"></div>
        <div class="skeleton-line" style="width: 90%;"></div>
      </div>
    </div>
  </div>
</div>

<button class="add-btn" onclick="window.location.href='/usdt.html'" type="button">
  Add Bank Account
</button>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-app.js";
  import { getFirestore, collection, query, orderBy, deleteDoc, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-firestore.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-auth.js"; // NEW IMPORT

  const firebaseConfig = {
    apiKey: "AIzaSyBplXdPF8ogTbsFOiNDPhBZIAUMPVJqDjc",
    authDomain: "first-47e77.firebaseapp.com",
    projectId: "first-47e77",
    storageBucket: "first-47e77.appspot.com",
    messagingSenderId: "326623691876",
    appId: "1:326623691876:web:ded81074a6f236ac3f0b71"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app); // NEW: Initialize auth

  function renderEmptyState() {
    return `
      <div class="emImgSec">
        <img src="/images/em.png" alt="" class="emimg">
        <p>Empty</p>
      </div>`;
  }

  function renderAccount(id, data) {
    return `
      <div class="card p-3 mb-2 shadow-sm">
        <i class="fa fa-trash delete-btn" data-id="${id}"></i>
        <strong>Account No:</strong> ${data.account} <br>
        <strong>IFSC:</strong> ${data.ifsc} <br>
        <strong>Name:</strong> ${data.name}
      </div>`;
  }

  function attachDeleteEvents(userId) { // MODIFIED: Pass userId
    document.querySelectorAll('.delete-btn').forEach(btn => {
      btn.onclick = async (e) => {
        e.stopPropagation();
        const id = btn.getAttribute('data-id');
        if (confirm("Are you sure you want to delete this account?")) {
          try {
            // NEW: Reference the correct user-specific document
            const accountDocRef = doc(db, "users", userId, "bankAccounts", id);
            await deleteDoc(accountDocRef);
            console.log("Document successfully deleted!");
          } catch (error) {
            console.error("Error removing document: ", error);
            alert("Failed to delete the account. Check console for details.");
          }
        }
      };
    });
  }

  function loadAccounts(userId) { // MODIFIED: Pass userId
    const userBankAccountsRef = collection(db, "users", userId, "bankAccounts"); // NEW: Use user-specific path
    const q = query(userBankAccountsRef, orderBy("timestamp", "desc"));
    const accountList = document.getElementById('accountList');
    
    onSnapshot(q, (snapshot) => {
      accountList.innerHTML = "";
      if (snapshot.empty) {
        accountList.innerHTML = renderEmptyState();
      } else {
        snapshot.forEach(docSnap => {
          accountList.innerHTML += renderAccount(docSnap.id, docSnap.data());
        });
        attachDeleteEvents(userId); // MODIFIED: Pass userId
      }
    });
  }

  // NEW: Check for user authentication before loading accounts
  onAuthStateChanged(auth, (user) => {
    const accountList = document.getElementById('accountList');
    if (user) {
      loadAccounts(user.uid);
    } else {
      accountList.innerHTML = `<p>Please log in to view your accounts.</p>`;
    }
  });
</script>

</body>
</html>