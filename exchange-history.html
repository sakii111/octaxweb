<!DOCTYPE html>
<html lang="en">


<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">

    <title>OCTA X</title>

    <link rel="stylesheet" href="/css/stylesheet.css">
    <link rel="stylesheet" href="/css/responsivestyle.css">
    <link rel="stylesheet" href="/font-awesome/css/font-awesome.min.css">

    <link rel="icon" type="image/x-icon" href="./images/favicon.png">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/js/bootstrap.bundle.min.js"></script>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

    <script src="https://kit.fontawesome.com/3defd9afa9.js" crossorigin="anonymous"></script>

    <script src="https://kit.fontawesome.com/a8f8257674.js" crossorigin="anonymous"></script>

    <link rel="icon" type="image/x-icon" href="/images/octalogo.jpg">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&family=Noto+Sans+Devanagari:wght@100..900&family=Noto+Serif+Devanagari:wght@100..900&family=Roboto+Flex:opsz,wght@8..144,100..1000&display=swap"
        rel="stylesheet">

    <script async src="https://www.googletagmanager.com/gtag/js?id=G-E4Q0VWHY3J"></script>
    <script>
        window.dataLayer = window.dataLayer || [];

        function gtag() {
            dataLayer.push(arguments);
        }
        gtag('js', new Date());

        gtag('config', 'G-E4Q0VWHY3J');
    </script>
    <style>
        .transaction-card {
            background-color: #fff;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 15px;
            position: relative;
        }

        .transaction-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
            margin-bottom: 10px;
        }

        .transaction-status {
            font-weight: bold;
            font-size: 14px;
            padding: 4px 8px;
            border-radius: 5px;
        }

        .status-pending {
            color: #ff9800;
            background-color: #fff3e0;
        }

        .transaction-details {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            color: #555;
        }

        .detail-label {
            font-weight: 500;
        }

        .detail-value {
            text-align: right;
            color: #333;
            word-break: break-all;
        }

        .empty-history {
            text-align: center;
            margin-top: 50px;
            color: #888;
        }

        #transaction-list {
            margin-top: 20px;
        }
    </style>
</head>

<body>


    <div class="mainbody">
        <div class="innerBody">


            <div class="otherhead otherheadSection">
                <a href="/mine.html">
                    <img src="/images/back.png" class="backimg">
                </a>
                <h4>Exchange History</h4>
            </div>

            <div id="transaction-list">
                </div>

            <div id="empty-state" class="emImgSec empty-history">
                <img src="/images/em.png" alt="Empty Image" class="emimg">
                <p>No transactions found.</p>
            </div>

        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, query, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables for Firebase config, etc.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = {
            apiKey: "AIzaSyBplXdPF8ogTbsFOiNDPhBZIAUMPVJqDjc",
            authDomain: "first-47e77.firebaseapp.com",
            projectId: "first-47e77",
            storageBucket: "first-47e77.appspot.com",
            messagingSenderId: "326623691876",
            appId: "1:326623691876:web:ded81074a6f236ac3f0b71"
        };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        let userId = null;

        document.addEventListener('DOMContentLoaded', () => {

            // Function to render a single transaction card
            function renderTransaction(transaction) {
                const transactionList = document.getElementById('transaction-list');
                const timestamp = transaction.createdAt ? transaction.createdAt.toDate() : new Date();

                const cardHtml = `
                    <div class="transaction-card">
                        <div class="transaction-header">
                            <span class="transaction-status status-pending">${transaction.status}</span>
                            <span class="transaction-date">${timestamp.toLocaleString()}</span>
                        </div>
                        <div class="transaction-details">
                            <div class="detail-row">
                                <span class="detail-label">Amount:</span>
                                <span class="detail-value">${transaction.amount} USDT</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Network:</span>
                                <span class="detail-value">${transaction.network}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Txid:</span>
                                <span class="detail-value">${transaction.txid}</span>
                            </div>
                        </div>
                    </div>
                `;
                transactionList.insertAdjacentHTML('beforeend', cardHtml);
            }

            // Auth state observer to fetch data after sign-in
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    const emptyState = document.getElementById('empty-state');
                    const transactionList = document.getElementById('transaction-list');

                    // Updated path to match the Firestore rules
                    const depositsRef = collection(db, `/users/${userId}/deposits`);
                    onSnapshot(depositsRef, (querySnapshot) => {
                        // Clear existing transactions
                        transactionList.innerHTML = '';
                        const transactions = [];
                        querySnapshot.forEach((doc) => {
                            transactions.push(doc.data());
                        });

                        if (transactions.length > 0) {
                            emptyState.style.display = 'none';
                            transactions.forEach(renderTransaction);
                        } else {
                            emptyState.style.display = 'block';
                        }
                    }, (error) => {
                        console.error("Error fetching transactions: ", error);
                        emptyState.style.display = 'block';
                    });

                } else {
                    console.log("No user is signed in. Signing in anonymously...");
                    try {
                        await signInAnonymously(auth);
                        userId = auth.currentUser.uid;
                    } catch (error) {
                        console.error("Anonymous sign-in failed:", error);
                    }
                }
            });

            // Initial sign-in on page load
            (async () => {
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Firebase Auth failed:", error);
                }
            })();
        });
    </script>


</body>

</html>